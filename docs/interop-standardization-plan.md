# Interoperability Standardization Plan

## 1. The Golden Rule: Defer to the Reference Implementation

The `age` and `age-plugin-se` command-line tools are the official, reference implementations. Our library **must** be 100% compatible with them. This means:
- Any key generated by our library must be usable by the `age` CLI.
- Any file encrypted by our library must be decryptable by the `age` CLI.
- Our library must be able to use keys and decrypt files generated by the `age` CLI.

To achieve this, we will adopt a new architecture where the `CLISecureEnclave` backend is treated as the "source of truth." The `native` and `js` backends will be refactored to be compatible wrappers around this standard, rather than independent, divergent implementations.

## 2. Identity and Key Representation Standard

- **Identity (`AGE-PLUGIN-SE-...`):** An identity string will **only** be the opaque, bech32-encoded format generated by `age-plugin-se keygen`. We will completely remove the non-standard, session-dependent identity generation from the `native` and `js` backends.
- **Recipient (`age1se1...`):** This will be the public key format derived from a standard identity.
- **Private Key Reference:** The `privateKeyRef` will be the full, unmodified identity string. This ensures that any backend can use it.

## 3. Unified Cryptographic Process

We will eliminate the flawed, re-implemented cryptographic logic in the `native` and `js` backends.

- **Encryption:** For all backends, the encryption process will be delegated to the `age` CLI via the `CLISecureEnclave`. This guarantees that all encrypted files adhere strictly to the official `age` format.
- **Decryption:** Similarly, decryption will be handled by the `age` CLI. This ensures we can decrypt any valid `age` file, regardless of which tool or backend created it.

## 4. Refactored Backend Responsibilities

The roles of the backends will be redefined to enforce this new standard:

- **`CLISecureEnclave` (Primary):** This will be the core engine for all cryptographic operations (key generation, encryption, decryption).
- **`NativeSecureEnclave` (Helper):** Its role will be reduced to two key functions:
    1.  **Accelerating `identityToRecipient`:** It can use the native Swift addon to quickly derive a recipient from an identity without calling the CLI.
    2.  **Providing a UI Context:** It can leverage the native `LocalAuthentication` framework to present biometric prompts when the CLI requires them.
- **`PureJSSecureEnclave` (Deprecated):** This backend is fundamentally incompatible with a hardware-based security model. Its attempt to simulate Secure Enclave operations in software is misleading and insecure. It will be deprecated and removed to eliminate confusion and enforce a consistent security posture.

By adopting this strategy, we will ensure that `pak-lib` is a reliable, secure, and fully interoperable client for the `age` ecosystem.